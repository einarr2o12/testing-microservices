# Minimal Prometheus Configuration with Helm
# Only Prometheus server, no duplicate collectors

# Disable all extra components (we have OpenTelemetry for metrics collection)
alertmanager:
  enabled: false

prometheus-node-exporter:
  enabled: false
  
kube-state-metrics:
  enabled: false
  
prometheus-pushgateway:
  enabled: false

# Only Prometheus server
server:
  # Disable persistence for resource constraints
  persistentVolume:
    enabled: false
  
  # Minimal resource limits
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi
  
  # Service configuration
  service:
    type: ClusterIP
    servicePort: 9090

# Global configuration
global:
  scrape_interval: 30s
  evaluation_interval: 30s

# Scrape configuration
serverFiles:
  prometheus.yml:
    scrape_configs:
      # OpenTelemetry Collector metrics from DaemonSet
      - job_name: 'otel-collector-infrastructure'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - observability
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            target_label: __address__
            regex: (.+);(.+)
            replacement: ${1}:${2}
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
      
      # Kong Gateway metrics
      - job_name: 'kong-gateway'
        static_configs:
          - targets: ['kong-kong-admin.kong.svc.cluster.local:8001']
        metrics_path: '/metrics'
        scrape_interval: 15s
      
      # Prometheus self-monitoring
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']